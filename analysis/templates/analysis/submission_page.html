<!DOCTYPE html>
<html lang="en">
  <head>
    {% load static %}  
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Submit Analysis </title>
    <script src="{% static 'js/jquery-3.7.1.min.js' %}"></script>
    <link rel="stylesheet" href="{% static 'css/bootstrap.min.css' %}">
    <link rel="stylesheet" href="{% static 'analysis/submission_style.css' %}">
    <script src="{% static 'js/popper.min.js' %}"></script>
    <script src="{% static 'js/bootstrap.min.js' %}"></script>
    {{ analysis_form.media }}
  </head>
  <body>
    <main>
        <div class="text-center mt-3 mb-3">
            <img class="img-fluid" src="{% static 'icons/TRANSECT_te_sm_t.png' %}">
        </div>
        <div class="container">
            <div id="input_args">
                <form id="input_form" method="POST">
                    {% csrf_token %}
                    <div id="select_script" class="card mt-3">
                        <div class="card-header">Script</div>
                        <div class="card-body">
                            <p>{{ analysis_form.script_type }}</p>
                        </div>
                    </div>
                    <div id="select_project" class="card mt-3">
                        <div class="card-header">Project</div>
                        <div class="card-body">
                            {{ analysis_form.project }}
                            {{ analysis_form.project.media }}
                        </div>
                    </div>
                    <div id="goi_settings" class="card mt-3">
                        <div class="card-header">Genes of Interest</div>
                            <div class="card-body">
                                {{ analysis_form.composite_analysis_type }}
                                {{ analysis_form.gene_selected }}
                                <div class="text-danger mt-3 submission_alert" id="goi_alert">
                                    <strong class="mx-2">Error!</strong> Please enter at least 2 Genes.
                                </div>
                            </div>
                        </div>
                    </div>
                    <span id="analysis_type_span">
                        <div id="analysis_type" class="card mt-3">
                            <div class="card-header">Analysis Type</div>
                                <div class="card-body">
                                    {{ analysis_form.do_correlation_analysis }} {{ analysis_form.do_correlation_analysis.label_tag }}
                                    {{ analysis_form.do_de_analysis }} {{ analysis_form.do_de_analysis.label_tag }}
                                    <div class="text-danger mt-3 submission_alert" id="analysis_type_alert">
                                        <strong class="mx-2">Error!</strong> Please select an analysis type.
                                    </div>
                                </div>
                        </div>
                    </span>
                    <div id="percentile_div" class="card mt-3 de_option">
                        <div class="card-header">Percentile</div>
                            <div class="card-body">
                                {{ analysis_form.percentile.label_tag }}
                                <div class="mt-3">{{ analysis_form.percentile }}</div>
                            </div>
                    </div>
                    <div id="optional_parameters" class="card mt-3 mb-3">
                        <div class="card-header">Optional Parameters</div>
                            <div class="card-body de_option">
                                <div id="use_mirna_button_div">
                                    {{ analysis_form.use_mirna }} {{ analysis_form.use_mirna.label_tag }}
                                </div>
                                <div id="switch_stratum_button_div">
                                    {{ analysis_form.switch_stratum }} {{ analysis_form.switch_stratum.label_tag }}
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="submission_and_loading_container" class="d-flex row mt-3 justify-content-md-center">
                        {% if analysis_form.errors %}
                            {% for error_list in analysis_form.errors.values %}
                                {% for error in error_list %}
                                    <strong class="d-flex column justify-content-md-center text-danger">{{ error }}</strong>
                                {% endfor %}
                            {% endfor %}
                        {% endif %}
                        <input type="submit" id="submit_req" class="btn btn-primary mt-3 column">
                    </div>
                </form>
            </div>
        </div>  
    </main>
	<script>
        $(document).ready(function() {
            $("[data-toggle=popover]").popover();
        });

        //  <strong class="mx-2 row  justify-content-md-center">{{ analysis_form.errors.as_data.values }}!</strong>

        // analysis type choice
        const correlation_checkbox = document.getElementById("correlation_checkbox")

        const optional_parameters = document.getElementById("optional_parameters")

        // rna species choice
        const use_mirna_checkbox = document.getElementById("use_mirna_checkbox")
        mirna_checkbox_label = document.querySelector(`label[for="${use_mirna_checkbox.id}"]`)

        // disabled at the start since no script option chosen
        use_mirna_checkbox.disabled = true;
        use_mirna_checkbox.checked = false;
        use_mirna_checkbox.style.cursor = "not-allowed";
        mirna_checkbox_label.style.cursor = "not-allowed";

        const script_choice = document.getElementById("script_choice")

        script_choice.addEventListener("change", () => {
            $("[name='project']").empty(); // in jquery, can fetch attribute in this manner
            // remember, we cannot use ID in conjunction with the forward widget in dal
            // as it will not work

            // also disable use_mirna_checkbox if not using GDC
            if (script_choice.value === "GDC") {
                use_mirna_checkbox.disabled = false;
                use_mirna_checkbox.style.cursor = "default";
                mirna_checkbox_label.style.cursor = "default";
            } else {
                use_mirna_checkbox.disabled = true;
                use_mirna_checkbox.checked = false;
                use_mirna_checkbox.style.cursor = "not-allowed";
                mirna_checkbox_label.style.cursor = "not-allowed";
            }
        })

        function trigger_de_checkbox() {
            show_de_options();
            document.getElementById("analysis_type_alert").style.display = "none";
        }

        const de_checkbox = document.getElementById("de_checkbox")
        de_checkbox.addEventListener("change", () => {trigger_de_checkbox()})

        // Disable the "Select an option" option in the rna_species dropdown
        // NEED TO WORK OUT WHY I NEEDED THIS OPTION IN THE FIRST PLACE BEFORE I DELETE IT
        // $("#rna_species_choices").change(function() {
        //     $("option[value='']").prop("disabled", true);
        // });

        const composite_analysis_choice = document.getElementById("composite_analysis_choice")
        composite_analysis_choice.addEventListener("change", change_goi_analysis)

        $('#gene_selected').on('select2:opening', function (e) {
            if (($('#gene_selected').val().length === 1 && composite_analysis_choice.value === "Single") ||
            ($('#gene_selected').val().length === 2 && composite_analysis_choice.value === "Ratio") ||
            ($('#gene_selected').val().length === 5 && composite_analysis_choice.value === "Additive")) {
                e.preventDefault();
                // how do I fetch the cursor?
                // e.target.style.cursor // does not work
            }
        })
        $('#gene_selected').on('change', function (e) {
            goi_alert.style.display = 'none'; 
            console.log($('#gene_selected'))
            if ($('#gene_selected').val().length === 0) {
                $('#gene_selected')[0].getElementsByTagName("option")[0].remove()
            } else {
                for (let i = 0; i < $('#gene_selected')[0].getElementsByTagName("option").length; i++ ) {
                    const gene_options = $('#gene_selected')[0].getElementsByTagName("option")[i].value
                    if ($('#gene_selected').val().includes(gene_options) === false) {
                        $('#gene_selected')[0].getElementsByTagName("option")[i].remove()
                        break
                    }
                }
            }
        })

        $("#composite_analysis_choice").change(function() {
            $("option[value='']").prop("disabled", true);
        });

        function enable_analysis_form() {
            const analysis_type = document.getElementById('analysis_type')
            analysis_type.style.pointerEvents = 'auto';
            analysis_type.style.filter = "brightness(1)";
            document.getElementById('analysis_type_span').style.cursor = "default";
        }

        function disable_analysis_form() {
            const analysis_type = document.getElementById('analysis_type')
            analysis_type.style.pointerEvents = 'none';
            analysis_type.style.filter = "brightness(0.7)";
            document.getElementById('analysis_type_span').style.cursor = "not-allowed";
        }

        // we should also make it such that choosing "Additive" or "ratio" analysis forcibly selects
        // DE analysis and removes the "Analysis Type" section.
        function change_goi_analysis() {
            goi_alert.style.display = 'none'
            if (composite_analysis_choice.value === "Single") {
                // DELETE EVERY GOI EXCEPT FIRST 1
                while ($('#gene_selected').val().length > 1) {
                    $('#gene_selected')[0].getElementsByTagName("option")[1].remove()
                    $('#gene_selected option:eq(1)').remove();
                }

                // same as the bottom when forcing the DE analysis, except we are reversing it here
                de_checkbox.checked = false
                trigger_de_checkbox()

                // re-enabling changing analysis type form
                enable_analysis_form()
            } else {
                if (composite_analysis_choice.value === "Ratio") {
                    // REMOVING EXCESS GOIS, KEEPING FIRST 2
                    while ($('#gene_selected').val().length > 2) {
                        // when you select an element initially, a new "select" tag is created for that item
                        // and appended to the dom for the gene_selected object.
                        // even if you delete an object, it will stay there as a select tag
                        // hence, need to also remove that object from the dom
                        // this is such that lets say you add GATA2 and ZEB1
                        // if you delete GATA2 and then ZEB1 and then add ZEB1 and GATA2
                        // it will not reverse the order as the GATA2 select object no longer preceeds ZEB1
                        $('#gene_selected')[0].getElementsByTagName("option")[2].remove()
                        $('#gene_selected option:eq(2)').remove();
                    }
                }

                // forcibly select DE analysis and unchecking correlation and prevent modifications to the Analysis section
                
                correlation_checkbox.checked = false
                de_checkbox.checked = true
                trigger_de_checkbox()

                // disabling changing analysis type form
                disable_analysis_form()
            }
        }

        const percentile_textbox = document.getElementById("percentile_value")

        function show_de_options() {
            const myElements = document.querySelectorAll(".de_option");
            if (de_checkbox.checked) {
                percentile_value.required = true;
                for (let i = 0; i < myElements.length; i++) {
                    myElements[i].style.display = "block";
                }
            } else {
                // bringing back default values
                percentile_value.required = false;
                percentile_textbox.value = ""
                use_mirna_checkbox.checked = false;
                document.getElementById("switch_stratum_checkbox").checked = false;


                for (let i = 0; i < myElements.length; i++) {
                    myElements[i].style.display = "none"
                }
            }
        }

        $('#input_form').submit(function(e) {
            if ($('.analysis-type-checkbox:checked').length === 0) {
                document.getElementById("analysis_type_alert").innerHTML = '<strong class="mx-2">Error!</strong> Please select an analysis type.'
                document.getElementById("analysis_type_alert").style.display = "block";
                e.preventDefault();
            } else if  ($('.analysis-type-checkbox:checked').length === 2) {
                document.getElementById("analysis_type_alert").innerHTML = '<strong class="mx-2">Error!</strong> Cannot select both analysis simultaneously.'
                document.getElementById("analysis_type_alert").style.display = "block";
                e.preventDefault();
            } else {
                document.getElementById("analysis_type_alert").style.display = "none";
            }

            const goi_alert = document.getElementById('goi_alert')
            if ($('#gene_selected').val().length === 1 && (composite_analysis_choice.value === "Additive")) {
                goi_alert.innerHTML = '<strong class="mx-2">Error!</strong> Please enter at least 2 Genes.'
                goi_alert.style.display = 'block'
                e.preventDefault();
            } else if ($('#gene_selected').val().length === 1 && (composite_analysis_choice.value === "Ratio")) {
                goi_alert.innerHTML = '<strong class="mx-2">Error!</strong> Please enter 2 Genes.'
                goi_alert.style.display = 'block'
                e.preventDefault();
            }
        });
    </script>
  </body>
</html>
